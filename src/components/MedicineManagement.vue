<template>
  <div class="medicine-management">
    <!-- Â§¥ÈÉ®Ê®™ÂπÖÂå∫Âüü -->
    <div class="header-banner">
      <div class="banner-content">
        <div class="banner-text">
          <h1 class="page-title">
            üíäËçØÂìÅÁÆ°ÁêÜ‰∏≠ÂøÉ
          </h1>
        </div>
        <div class="banner-actions">
          <el-button type="primary" size="large" @click="showAddForm = true" class="add-button">
            <el-icon><Plus /></el-icon>
            Ê∑ªÂä†Áî®ËçØËÆ∞ÂΩï
          </el-button>
        </div>
      </div>
    </div>

    <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâÂå∫Âüü -->
    <div class="search-section">
      <div class="search-container">
        <div class="search-autocomplete-wrapper">
          <el-autocomplete
              v-model="searchQuery"
              :fetch-suggestions="searchQuerySuggestions"
              placeholder="üîç ÊêúÁ¥¢ËçØÂìÅÂêçÁß∞‰∫ÜËß£Áõ∏ÂÖ≥‰ø°ÊÅØ"
              clearable
              size="large"
              class="search-input"
              @select="handleSearchSelect"
              @keyup.enter="searchMedicine"
              :trigger-on-focus="false"
              :debounce="300"
          >
            <template #append>
              <el-button @click="searchMedicine" type="primary" class="search-btn">
                ÊêúÁ¥¢
              </el-button>
            </template>
            <template #default="{ item }">
              <div class="search-suggestion-item">
                <div class="suggestion-name">{{ item.value }}</div>
                <div class="suggestion-info">{{ item.info }}</div>
              </div>
            </template>
          </el-autocomplete>
        </div>
      </div>
      <div class="filter-controls">
        <el-select v-model="periodFilter" @change="fetchMedicineRecords" class="period-filter">
          <el-option label="üìÖ Êú¨Âë®" value="week" />
          <el-option label="üìÖ Êú¨Êúà" value="month" />
          <el-option label="üìÖ ÂÖ®ÈÉ®ËÆ∞ÂΩï" value="all" />
        </el-select>
      </div>
    </div>    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="main-content">
      <!-- Áî®ËçØËÆ∞ÂΩïÂç°Áâá -->
      <el-card class="medicine-records-card" shadow="hover">
        <template #header>
          <div class="card-header">            
            <div class="header-title">
              <el-icon class="header-icon"><TrendCharts /></el-icon>
              <span>Áî®ËçØËÆ∞ÂΩï</span>
              <el-badge :value="medicineRecords.length" class="record-count" />
            </div>
            <div class="header-actions">
            </div>
          </div>
        </template>

        <div class="card-body">
          <el-empty v-if="!loading && !medicineRecords.length" 
                   description="ËøòÊ≤°ÊúâÁî®ËçØËÆ∞ÂΩïÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ËÆ∞ÂΩïÂêßÔºÅ"
                   class="custom-empty"
                   :image-size="120">
            <template #image>
              <div class="empty-image">üíä</div>
            </template>
          </el-empty>

          <el-scrollbar max-height="calc(70vh - 200px)" class="records-scrollbar">
            <div class="records-grid">
              <div
                  v-for="record in medicineRecords"
                  :key="record.id"
                  class="record-card"
              >
                <div class="record-header">
                  <div class="medicine-info">
                    <h3 class="medicine-name">{{ record.name }}</h3>
                    <el-tag size="small" type="success" class="status-tag">ËøõË°å‰∏≠</el-tag>
                  </div>
                  <div class="record-menu">
                    <el-dropdown trigger="click">
                      <el-button type="text" class="menu-btn">
                        <el-icon><MoreFilled /></el-icon>
                      </el-button>
                      <template #dropdown>
                        <el-dropdown-menu>
                          <el-dropdown-item @click="showMedicineDetails(record)">
                            <el-icon><InfoFilled /></el-icon>
                            Êü•ÁúãËØ¶ÊÉÖ
                          </el-dropdown-item>
                          <el-dropdown-item @click="setReminder(record.id)">
                            <el-icon><Bell /></el-icon>
                            ËÆæÁΩÆÊèêÈÜí
                          </el-dropdown-item>
                          <el-dropdown-item @click="editRecord(record)">
                            <el-icon><Edit /></el-icon>
                            ÁºñËæëËÆ∞ÂΩï
                          </el-dropdown-item>
                        </el-dropdown-menu>
                      </template>
                    </el-dropdown>
                  </div>
                </div>

                <div class="record-content">
                  <div class="info-grid">                    <div class="info-item">
                      <el-icon class="info-icon"><CirclePlus /></el-icon>
                      <div class="info-text">
                        <span class="info-label">ÂâÇÈáè</span>
                        <span class="info-value">{{ record.dosage }}</span>
                      </div>
                    </div>
                    
                    <div class="info-item">
                      <el-icon class="info-icon"><Clock /></el-icon>
                      <div class="info-text">
                        <span class="info-label">È¢ëÁéá</span>
                        <span class="info-value">{{ record.frequency }}</span>
                      </div>
                    </div>
                  </div>

                  <div v-if="record.startDate" class="date-range">
                    <el-icon class="date-icon"><Calendar /></el-icon>
                    <span class="date-text">
                      {{ record.startDate }} 
                      <span class="date-separator">Ëá≥</span>
                      {{ record.endDate || 'ÊåÅÁª≠ÊúçÁî®‰∏≠' }}
                    </span>
                  </div>                  <div v-if="record.notes" class="notes-section">
                    <el-icon class="notes-icon"><Document /></el-icon>
                    <p class="notes-text">{{ record.notes }}</p>
                  </div>
                </div>
              </div>
            </div>
          </el-scrollbar>
        </div>
      </el-card>      <!-- Áî®ËçØÊèêÈÜíÂç°Áâá -->
      <el-card class="medicine-reminders-card" shadow="hover">
        <template #header>
          <div class="card-header">            <div class="header-title">
              <el-icon class="header-icon"><Bell /></el-icon>
              <span>Áî®ËçØÊèêÈÜí</span>
              <el-badge :value="reminders.filter(r => r.isActive).length" class="reminder-count" type="warning" />
            </div>
          </div>
        </template>

        <div class="card-body">
          <el-empty v-if="!reminders.length" 
                   description="ÊöÇÊó†Áî®ËçØÊèêÈÜíÔºå‰∏∫ÊÇ®ÁöÑËçØÂìÅËÆæÁΩÆÊèêÈÜíÂêßÔºÅ"
                   class="custom-empty"
                   :image-size="100">
            <template #image>
              <div class="empty-image">‚è∞</div>
            </template>
          </el-empty>          <el-scrollbar height="calc(70vh - 200px)" class="reminders-scrollbar">
            <div class="reminders-list">
              <div
                  v-for="reminder in reminders"
                  :key="reminder.id"
                  class="reminder-card"
                  :class="{ 'reminder-active': reminder.isActive }"
              >
                <div class="reminder-status">
                  <div class="status-indicator" :class="{ 'active': reminder.isActive }"></div>
                </div>                <div class="reminder-content">                  <div class="reminder-header">
                    <div class="reminder-info">
                      <h4 class="reminder-title">{{ generateReminderTitle(reminder) }}</h4>
                    </div>
                    <el-tag 
                        size="small" 
                        :type="reminder.isActive ? 'success' : 'info'"
                        class="reminder-status-tag"
                    >
                      {{ reminder.isActive ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®' }}
                    </el-tag>
                  </div>
                  
                  <div class="reminder-details">
                    <div class="detail-row">
                      <el-icon class="detail-icon"><Timer /></el-icon>
                      <span class="detail-text">{{ reminder.reminderTime }}</span>
                    </div>
                    <div class="detail-row">
                      <el-icon class="detail-icon"><Refresh /></el-icon>
                      <span class="detail-text">{{ formatRepeatType(reminder.repeatType) }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="reminder-actions">
                  <el-switch
                      v-model="reminder.isActive"
                      @change="toggleReminder(reminder)"
                      class="reminder-switch"
                      :active-text="reminder.isActive ? 'ÂêØÁî®' : ''"
                      :inactive-text="!reminder.isActive ? 'Á¶ÅÁî®' : ''"
                  />
                  <el-button
                      type="danger"
                      size="small"
                      @click="deleteReminder(reminder)"
                      class="delete-btn"
                  >
                    <el-icon><Delete /></el-icon>
                  </el-button>
                </div>
              </div>
            </div>
          </el-scrollbar>
        </div>
      </el-card>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÁî®ËçØËÆ∞ÂΩïÂØπËØùÊ°Ü -->
    <el-dialog
        v-model="showAddForm"
        :title="isEditing ? 'ÁºñËæëÁî®ËçØËÆ∞ÂΩï' : 'Ê∑ªÂä†Áî®ËçØËÆ∞ÂΩï'"
        width="500px"
        destroy-on-close
    >
      <el-form
          ref="medicineFormRef"
          :model="medicineForm"
          :rules="formRules"
          label-width="100px"
      >
        <el-form-item label="ËçØÂìÅÂêçÁß∞" prop="name">
          <el-autocomplete
              v-model="medicineForm.name"
              :fetch-suggestions="querySearch"
              placeholder="ËæìÂÖ•ËçØÂìÅÂêçÁß∞(Ëá≥Â∞ë2‰∏™Â≠óÁ¨¶)"
              @select="handleSelect"
              class="w-full"
              :trigger-on-focus="false"
          />
        </el-form-item>

        <!-- ÂâÇÈáèÈÉ®ÂàÜ -->
        <el-form-item label="Áî®ËçØÂâÇÈáè">
          <el-form-item prop="dosageAmount" class="dosage-form-item" style="margin-bottom: 0">
            <el-input-number
                v-model="medicineForm.dosageAmount"
                :min="0.1"
                :step="0.1"
                :precision="1"
                controls-position="right"
                class="dosage-input"
            />
          </el-form-item>
          <el-form-item prop="dosageUnit" style="margin-bottom: 0">
            <el-select
                v-model="medicineForm.dosageUnit"
                class="unit-select"
                placeholder="Âçï‰Ωç"
            >
              <el-option label="ÊØ´ÂÖã(mg)" value="mg" />
              <el-option label="ÂÖã(g)" value="g" />
              <el-option label="ÊØ´Âçá(ml)" value="ml" />
              <el-option label="Áâá" value="Áâá" />
              <el-option label="Á≤í" value="Á≤í" />
              <el-option label="ÊîØ" value="ÊîØ" />
            </el-select>
          </el-form-item>
        </el-form-item>

        <!-- È¢ëÁéáÈÉ®ÂàÜ -->
        <el-form-item label="ÊúçÁî®È¢ëÁéá">
          <el-form-item prop="frequencyTimes" class="frequency-form-item">
            <el-select
                v-model="medicineForm.frequencyTimes"
                class="frequency-select"
            >
              <el-option label="ÊØèÂ§©1Ê¨°" value="1" />
              <el-option label="ÊØèÂ§©2Ê¨°" value="2" />
              <el-option label="ÊØèÂ§©3Ê¨°" value="3" />
              <el-option label="ÊØèÂ§©4Ê¨°" value="4" />
            </el-select>
          </el-form-item>
          <el-form-item prop="frequencyPeriod" class="period-form-item">
            <el-select
                v-model="medicineForm.frequencyPeriod"
                class="period-select"
            >
              <el-option label="È§êÂâç" value="beforeMeal" />
              <el-option label="È§êÂêé" value="afterMeal" />
              <el-option label="Á©∫ËÖπ" value="emptyStomach" />
              <el-option label="‰ªªÊÑèÊó∂Èó¥" value="anytime" />
            </el-select>
          </el-form-item>
        </el-form-item>

        <el-form-item label="ÊúçÁî®Êó∂Èó¥" v-if="medicineForm.frequencyTimes">
          <div class="time-select-container">
            <el-time-select
                v-for="index in Number(medicineForm.frequencyTimes)"
                :key="index"
                v-model="medicineForm.frequencyTiming[index-1]"
                class="time-select-item"
                :start="'00:00'"
                :step="'00:30'"
                :end="'23:30'"
                placeholder="ÈÄâÊã©Êó∂Èó¥"
            />
          </div>
        </el-form-item>

        <el-form-item label="ÂºÄÂßãÊó•Êúü" prop="startDate">
          <el-date-picker
              v-model="medicineForm.startDate"
              type="date"
              placeholder="ÈÄâÊã©ÂºÄÂßãÊó•Êúü"
              value-format="YYYY-MM-DD"
          />
        </el-form-item>

        <el-form-item label="ÁªìÊùüÊó•Êúü" prop="endDate">
          <el-date-picker
              v-model="medicineForm.endDate"
              type="date"
              placeholder="ÈÄâÊã©ÁªìÊùüÊó•Êúü"
              value-format="YYYY-MM-DD"
              :disabled-date="disableInvalidEndDates"
          />
        </el-form-item>

        <el-form-item label="Â§áÊ≥®" prop="notes">
          <el-input
              v-model="medicineForm.notes"
              type="textarea"
              :rows="3"
              placeholder="ËØ∑Â°´ÂÜôÁî®ËçØÊ≥®ÊÑè‰∫ãÈ°πÁ≠â‰ø°ÊÅØ"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="cancelForm">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitForm">Á°ÆÂÆö</el-button>
      </template>
    </el-dialog>

    <!-- ËÆæÁΩÆÊèêÈÜíÂØπËØùÊ°Ü -->
    <el-dialog
        v-model="showReminderForm"
        title="ËÆæÁΩÆÁî®ËçØÊèêÈÜí"
        width="400px"
    >
      <el-form :model="reminderForm" label-width="100px">
        <el-form-item label="ÊèêÈÜíÊó∂Èó¥" required>
          <el-time-picker
              v-model="reminderForm.reminderTime"
              format="HH:mm"
              value-format="HH:mm:ss"
              placeholder="ÈÄâÊã©Êó∂Èó¥"
          />
        </el-form-item>
        <el-form-item label="ÈáçÂ§çÁ±ªÂûã" required>
          <el-select v-model="reminderForm.repeatType">
            <el-option label="ÊØèÂ§©" value="daily" />
            <el-option label="ÊØèÂë®" value="weekly" />
            <el-option label="ÊØèÊúà" value="monthly" />
          </el-select>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showReminderForm = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitReminder">Á°ÆÂÆö</el-button>
      </template>
    </el-dialog>

    <!-- ËçØÂìÅËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog
        v-model="showDetailsDialog"
        title="ËçØÂìÅËØ¶ÊÉÖ"
        width="800px"
        :fullscreen="false"
    >
      <el-scrollbar height="600px">
        <div class="drug-details">
          <!-- Âü∫Êú¨‰ø°ÊÅØ -->
          <el-card class="mb-4">
            <template #header>
              <div class="card-header">
                <span>Âü∫Êú¨‰ø°ÊÅØ</span>
              </div>
            </template>
            <el-descriptions :column="1" border>
              <el-descriptions-item label="ÂìÅÁâåÂêç">{{ selectedMedicine.brandName }}</el-descriptions-item>
              <el-descriptions-item label="ÈÄöÁî®Âêç">{{ selectedMedicine.genericName }}</el-descriptions-item>
              <el-descriptions-item label="Âà∂ÈÄ†ÂïÜ">{{ selectedMedicine.manufacturer }}</el-descriptions-item>
              <el-descriptions-item label="‰ΩøÁî®ÊñπÂºè">{{ selectedMedicine.route }}</el-descriptions-item>
              <el-descriptions-item label="ËçØÂìÅÁ±ªÂûã">{{ selectedMedicine.productType }}</el-descriptions-item>
            </el-descriptions>
          </el-card>

          <!-- ‰ΩøÁî®‰ø°ÊÅØ -->
          <el-card class="mb-4">
            <template #header>
              <div class="card-header">
                <span>‰ΩøÁî®‰ø°ÊÅØ</span>
              </div>
            </template>
            <el-descriptions :column="1" border>
              <el-descriptions-item label="Áî®ÈÄî">{{ selectedMedicine.purpose }}</el-descriptions-item>
              <el-descriptions-item label="ÈÄÇÂ∫îÁóá">{{ selectedMedicine.indications }}</el-descriptions-item>
              <el-descriptions-item label="Áî®Ê≥ïÁî®Èáè">{{ selectedMedicine.dosage }}</el-descriptions-item>
            </el-descriptions>
          </el-card>

          <!-- Ë≠¶Âëä‰ø°ÊÅØ -->
          <el-card class="mb-4">
            <template #header>
              <div class="card-header">
                <span class="text-red-600">Ë≠¶Âëä‰ø°ÊÅØ</span>
              </div>
            </template>
            <el-collapse>
              <el-collapse-item title="Ë≠¶Âëä‰∫ãÈ°π" name="1">
                <div class="p-3">{{ selectedMedicine.warnings }}</div>
              </el-collapse-item>
              <el-collapse-item title="Á¶ÅÂøå" name="2">
                <div class="p-3">{{ selectedMedicine.doNotUse }}</div>
              </el-collapse-item>
              <el-collapse-item title="Áî®ËçØÊúüÈó¥Ê≥®ÊÑè‰∫ãÈ°π" name="3">
                <div class="p-3">{{ selectedMedicine.whenUsing }}</div>
              </el-collapse-item>
              <el-collapse-item title="ÂÅúËçØÊåáÂæÅ" name="4">
                <div class="p-3">{{ selectedMedicine.stopUse }}</div>
              </el-collapse-item>
            </el-collapse>
          </el-card>

          <!-- ÂÖ∂‰ªñ‰ø°ÊÅØ -->
          <el-card>
            <template #header>
              <div class="card-header">
                <span>ÂÖ∂‰ªñ‰ø°ÊÅØ</span>
              </div>
            </template>
            <el-descriptions :column="1" border>
              <el-descriptions-item label="ÂÇ®Â≠òÊù°‰ª∂">{{ selectedMedicine.storage }}</el-descriptions-item>
              <el-descriptions-item label="ÊúâÊïàÊàêÂàÜ">{{ selectedMedicine.activeIngredient }}</el-descriptions-item>
              <el-descriptions-item label="ÈùûÊ¥ªÊÄßÊàêÂàÜ">{{ selectedMedicine.inactiveIngredient }}</el-descriptions-item>
            </el-descriptions>            </el-card>
        </div>
      </el-scrollbar>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted ,watch, nextTick} from 'vue'
import { useStore } from 'vuex'
import { useRouter } from 'vue-router'
import { ElMessage,ElMessageBox } from 'element-plus'
import MedicineService from '@/services/MedicineService'
import {
  Search,
  Plus,
  Bell, 
  Clock,
  Edit,
  Refresh,
  InfoFilled,
  Calendar,
  Document,
  Timer,
  Stopwatch,
  Delete,
  House,
  TrendCharts,
  MoreFilled,
  CirclePlus,
  View
} from '@element-plus/icons-vue'

const formatRepeatType = (type) => {
  const types = {
    'DAILY': 'ÊØèÂ§©',
    'WEEKLY': 'ÊØèÂë®',
    'MONTHLY': 'ÊØèÊúà'
  };
  return types[type] || type;
};

const generateReminderTitle = (reminder) => {
  // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñËçØÂìÅÂêçÁß∞
  let medicineName = '';
  
  // 1. ‰ªéÂÖ≥ËÅîÁöÑmedicineÂØπË±°Ëé∑Âèñ
  if (reminder.medicine && reminder.medicine.name) {
    medicineName = reminder.medicine.name;
  }
  // 2. ‰ªémedicineNameÂ≠óÊÆµËé∑Âèñ
  else if (reminder.medicineName) {
    medicineName = reminder.medicineName;
  }
  // 3. ‰ªémedicineÂØπË±°ÁöÑÂÖ∂‰ªñÂèØËÉΩÂ≠óÊÆµËé∑Âèñ
  else if (reminder.medicine && reminder.medicine.medicineName) {
    medicineName = reminder.medicine.medicineName;
  }
  // 4. ÈªòËÆ§ÂÄº
  else {
    medicineName = 'Êú™Áü•ËçØÂìÅ';
  }
  
  return `${medicineName} ÊúçËçØÊèêÈÜí`;
};

const router = useRouter()
const store = useStore()
const userId = ref(store.state.user?.id)
const medicineFormRef = ref(null)

const medicineRecords = ref([])
const reminders = ref([])
const searchQuery = ref('')
const loading = ref(false)
const showAddForm = ref(false)
const showReminderForm = ref(false)
const showDetailsDialog = ref(false)
const isEditing = ref(false)
const periodFilter = ref('week')
const selectedMedicine = ref(null)

const reminderForm = ref({
  medicineId: null,
  reminderTime: null,
  repeatType: 'daily',
  isActive: true
});

const initMedicineForm = () => ({
  id: null,
  name: '',
  dosageAmount: 1,
  dosageUnit: '',
  frequencyTimes: '',
  frequencyPeriod: '',
  frequencyTiming: [],
  startDate: '',
  endDate: '',
  notes: '',
  drugInfo: null
})

const medicineForm = ref(initMedicineForm())

// Êó•ÊúüÁ¶ÅÁî®ÂáΩÊï∞
const disablePastDates = (date) => {
  return date < new Date(new Date().setHours(0, 0, 0, 0))
}

const disableInvalidEndDates = (date) => {
  if (!medicineForm.value.startDate) return false
  return date < new Date(medicineForm.value.startDate)
}

const formRules = {
  name: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ËçØÂìÅÂêçÁß∞', trigger: 'blur' },
    { min: 2, message: 'ËçØÂìÅÂêçÁß∞Ëá≥Â∞ë2‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  // ÂâÇÈáèÁõ∏ÂÖ≥ÁöÑÈ™åËØÅ
  dosageAmount: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Áî®ËçØÂâÇÈáè', trigger: 'blur' },
    { type: 'number', min: 0.1, message: 'ÂâÇÈáèÂøÖÈ°ªÂ§ß‰∫é0', trigger: 'blur' }
  ],
  dosageUnit: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÂâÇÈáèÂçï‰Ωç', trigger: 'change' }
  ],
  // È¢ëÁéáÁõ∏ÂÖ≥ÁöÑÈ™åËØÅ
  frequencyTimes: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊúçÁî®Ê¨°Êï∞', trigger: 'change' }
  ],
  frequencyPeriod: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊúçÁî®Êó∂ÊÆµ', trigger: 'change' }
  ],
  // Êó•ÊúüÁõ∏ÂÖ≥ÁöÑÈ™åËØÅ
  startDate: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÂºÄÂßãÊó•Êúü', trigger: 'change' }
  ]
}

const searchResults = ref([])

// ÊêúÁ¥¢Âª∫ËÆÆÂäüËÉΩ
const searchQuerySuggestions = async (queryString, cb) => {
  if (!queryString || queryString.length < 2) {
    cb([]);
    return;
  }

  try {
    // ÂÖà‰ªéÊú¨Âú∞Áî®ËçØËÆ∞ÂΩï‰∏≠ÊêúÁ¥¢ÂåπÈÖçÈ°π
    const localSuggestions = medicineRecords.value
      .filter(record => 
        record.name?.toLowerCase().includes(queryString.toLowerCase()) ||
        record.dosage?.toLowerCase().includes(queryString.toLowerCase()) ||
        record.notes?.toLowerCase().includes(queryString.toLowerCase())
      )
      .map(record => ({
        value: record.name,
        info: `${record.dosage} - ${record.frequency}`,
        type: 'local',
        data: record
      }))
      .slice(0, 3); // ÈôêÂà∂Êú¨Âú∞Âª∫ËÆÆÊï∞Èáè

    // Â¶ÇÊûúÊú¨Âú∞Âª∫ËÆÆ‰∏çË∂≥Ôºå‰ªéÂ§ñÈÉ®APIËé∑ÂèñËçØÂìÅÂª∫ËÆÆ
    let apiSuggestions = [];
    if (localSuggestions.length < 5) {
      try {
        const response = await MedicineService.searchDrugLabels(queryString);
        apiSuggestions = response.results?.slice(0, 5 - localSuggestions.length).map(result => ({
          value: result.openfda?.brand_name?.[0] || result.openfda?.generic_name?.[0],
          info: `${result.openfda?.manufacturer_name?.[0] || 'Êú™Áü•ÂéÇÂïÜ'} - ${result.openfda?.product_type?.[0] || 'ËçØÂìÅ'}`,
          type: 'api',
          data: result
        })) || [];
      } catch (error) {
        console.log('Â§ñÈÉ®ËçØÂìÅÊêúÁ¥¢ÊöÇ‰∏çÂèØÁî®Ôºå‰ªÖÊòæÁ§∫Êú¨Âú∞Âª∫ËÆÆ');
      }
    }

    // ÂêàÂπ∂Êú¨Âú∞ÂíåAPIÂª∫ËÆÆ
    const allSuggestions = [...localSuggestions, ...apiSuggestions];
    cb(allSuggestions);
    
  } catch (error) {
    console.error('Error fetching search suggestions:', error);
    cb([]);
  }
};

const handleSearchSelect = (item) => {
  if (item) {
    searchQuery.value = item.value;
    // Â¶ÇÊûúÈÄâÊã©ÁöÑÊòØÊú¨Âú∞ËÆ∞ÂΩïÔºåÁõ¥Êé•ËøáÊª§ÊòæÁ§∫
    if (item.type === 'local') {
      searchMedicine();
    }
  }
};

const querySearch = async (queryString, cb) => {
  if (queryString.length < 2) {
    cb([]);
    return;
  }

  try {
    const response = await MedicineService.searchDrugLabels(queryString);
    const suggestions = response.results?.map(result => ({
      value: result.openfda?.brand_name?.[0] || result.openfda?.generic_name?.[0],
      data: result
    })) || [];
    cb(suggestions);
  } catch (error) {
    console.error('Error fetching suggestions:', error);
    cb([]);
  }
};


const handleSelect = (item) => {
  if (item) {
    medicineForm.value.name = item.value
    medicineForm.value.drugInfo = item.data
    const result = item.data;
    selectedMedicine.value = {
      name: item.value,
      brandName: result.openfda?.brand_name?.[0] || 'Êú™Êèê‰æõ',
      genericName: result.openfda?.generic_name?.[0] || 'Êú™Êèê‰æõ',
      manufacturer: result.openfda?.manufacturer_name?.[0] || 'Êú™Êèê‰æõ',
      route: result.openfda?.route?.[0] || 'Êú™Êèê‰æõ',
      productType: result.openfda?.product_type?.[0] || 'Êú™Êèê‰æõ',
      purpose: result.purpose?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      indications: result.indications_and_usage?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      dosage: result.dosage_and_administration?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      warnings: result.warnings?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      doNotUse: result.do_not_use?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      whenUsing: result.when_using?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      stopUse: result.stop_use?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      storage: result.storage_and_handling?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      activeIngredient: result.active_ingredient?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      inactiveIngredient: result.inactive_ingredient?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ'
    };
    if (item.data.dosage_and_administration?.[0]) {
      ElMessage.info('Â∑≤Ëá™Âä®Â°´ÂÖÖÊé®ËçêÁî®Ê≥ïÁî®Èáè,ËØ∑Ê†πÊçÆÂÆûÈôÖÊÉÖÂÜµË∞ÉÊï¥')
    }
  }
};

const fetchMedicineRecords = async () => {
  try {
    loading.value = true
    const response = await MedicineService.getUserMedicineRecords(userId.value, periodFilter.value)
    medicineRecords.value = response.data || []
  } catch (error) {
    console.error('Ëé∑ÂèñÁî®ËçØËÆ∞ÂΩïÂ§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñÁî®ËçØËÆ∞ÂΩïÂ§±Ë¥•')
  } finally {
    loading.value = false
  }
}

const fetchReminders = async () => {
  try {
    const response = await MedicineService.getMedicineReminders(userId.value)
    reminders.value = response.data || []
    
    // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØÔºåÊü•ÁúãËøîÂõûÁöÑÊï∞ÊçÆÁªìÊûÑ
    console.log('Ëé∑ÂèñÂà∞ÁöÑÊèêÈÜíÊï∞ÊçÆ:', response.data)
    if (response.data && response.data.length > 0) {
      console.log('Á¨¨‰∏Ä‰∏™ÊèêÈÜíÁöÑËØ¶ÁªÜ‰ø°ÊÅØ:', response.data[0])
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÁî®ËçØÊèêÈÜíÂ§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñÁî®ËçØÊèêÈÜíÂ§±Ë¥•')
  }
}

const deleteReminder = async (reminder) => {
  try {
    await ElMessageBox.confirm(
        `Á°ÆÂÆöË¶ÅÂà†Èô§${reminder.medicineName}ÁöÑÊèêÈÜíÂêóÔºü`,
        'Âà†Èô§Á°ÆËÆ§',
        {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning',
        }
    );

    const response = await MedicineService.deleteMedicineReminder(userId.value, reminder.id);

    if (response && response.code === 200) {
      ElMessage.success('Âà†Èô§ÊèêÈÜíÊàêÂäü');
      await fetchReminders();
    } else {
      throw new Error(response?.message || 'Âà†Èô§ÊèêÈÜíÂ§±Ë¥•');
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Âà†Èô§ÊèêÈÜíÂ§±Ë¥•:', error);
      ElMessage.error(error.message || 'Âà†Èô§ÊèêÈÜíÂ§±Ë¥•');
    }
  }
};

const refreshRecords = () => {
  fetchMedicineRecords()
  fetchReminders()
}

const showMedicineDetails = async (record) => {
  try {
    loading.value = true;
    console.log('ÊòæÁ§∫ËçØÂìÅËØ¶ÊÉÖ, ËçØÂìÅÂêçÁß∞:', record.name);

    let drugData = null;

    // Â§ÑÁêÜÊú¨Âú∞Â≠òÂÇ®ÁöÑËçØÂìÅ‰ø°ÊÅØ
    if (record.drugInfo) {
      try {
        drugData = typeof record.drugInfo === 'string'
            ? JSON.parse(record.drugInfo)
            : record.drugInfo;

        if (drugData.results && drugData.results.length > 0) {
          drugData = drugData.results[0];
        }

        console.log('‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑ÂèñÁöÑËçØÂìÅ‰ø°ÊÅØ:', drugData);
      } catch (e) {
        console.warn('Ëß£ÊûêÊú¨Âú∞ËçØÂìÅ‰ø°ÊÅØÂ§±Ë¥•:', e);
        drugData = null;
      }
    }

    // Â¶ÇÊûúÊ≤°ÊúâÊú¨Âú∞Êï∞ÊçÆÔºåÂ∞ùËØï‰ªé API Ëé∑Âèñ
    if (!drugData || !drugData.openfda) {
      try {
        // ÂÖà‰ΩøÁî®ËçØÂìÅÂêçÁß∞Â∞ùËØïÁ≤æÁ°ÆÊêúÁ¥¢
        let response = await MedicineService.searchDrugLabels(record.name);

        if (!response.results?.length) {
          // Â¶ÇÊûúÁ≤æÁ°ÆÊêúÁ¥¢Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî®Êõ¥ÁÆÄÂçïÁöÑÊêúÁ¥¢Êù°‰ª∂
          const simpleName = record.name.split(' ')[0]; // Âè™‰ΩøÁî®Á¨¨‰∏Ä‰∏™ËØç
          console.log('‰ΩøÁî®ÁÆÄÂåñÂêçÁß∞ÊêúÁ¥¢:', simpleName);
          response = await MedicineService.searchDrugLabels(simpleName);
        }

        if (response.results?.length > 0) {
          drugData = response.results[0];
          // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
          await MedicineService.updateMedicineRecord(userId.value, {
            ...record,
            drugInfo: JSON.stringify(drugData)
          });
          console.log('‰ªéAPIËé∑ÂèñÁöÑËçØÂìÅ‰ø°ÊÅØ:', drugData);
        }
      } catch (error) {
        console.error('API ÊêúÁ¥¢Â§±Ë¥•:', error);
      }
    }

    if (drugData && drugData.openfda) {
      setSelectedMedicine(drugData);
      showDetailsDialog.value = true;
    } else {
      ElMessage({
        message: 'Êú™ÊâæÂà∞ËØ•ËçØÂìÅÁöÑËØ¶ÁªÜ‰ø°ÊÅØÔºåËØ∑Ê£ÄÊü•ËçØÂìÅÂêçÁß∞ÊòØÂê¶Ê≠£Á°ÆÊàñÁ®çÂêéÈáçËØï',
        type: 'warning',
        duration: 5000
      });
    }
  } catch (error) {
    console.error('Ëé∑ÂèñËçØÂìÅËØ¶ÊÉÖÂ§±Ë¥•:', error);
    ElMessage.error('Ëé∑ÂèñËçØÂìÅËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
  } finally {
    loading.value = false;
  }
};


const setSelectedMedicine = (data) => {
  try {
    console.log('ÂºÄÂßãÂ§ÑÁêÜËçØÂìÅÊï∞ÊçÆ:', data);

    // ÂàùÂßãÂåñ selectedMedicine
    selectedMedicine.value = {
      name: 'ÊöÇÊó†‰ø°ÊÅØ',
      brandName: 'ÊöÇÊó†‰ø°ÊÅØ',
      genericName: 'ÊöÇÊó†‰ø°ÊÅØ',
      manufacturer: 'ÊöÇÊó†‰ø°ÊÅØ',
      route: 'ÊöÇÊó†‰ø°ÊÅØ',
      productType: 'ÊöÇÊó†‰ø°ÊÅØ',
      purpose: 'ÊöÇÊó†‰ø°ÊÅØ',
      indications: 'ÊöÇÊó†‰ø°ÊÅØ',
      dosage: 'ÊöÇÊó†‰ø°ÊÅØ',
      warnings: 'ÊöÇÊó†‰ø°ÊÅØ',
      doNotUse: 'ÊöÇÊó†‰ø°ÊÅØ',
      whenUsing: 'ÊöÇÊó†‰ø°ÊÅØ',
      stopUse: 'ÊöÇÊó†‰ø°ÊÅØ',
      storage: 'ÊöÇÊó†‰ø°ÊÅØ',
      activeIngredient: 'ÊöÇÊó†‰ø°ÊÅØ',
      inactiveIngredient: 'ÊöÇÊó†‰ø°ÊÅØ'
    };

    // Â¶ÇÊûúÊï∞ÊçÆÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂÖàËß£ÊûêÊàêÂØπË±°
    let drugData = data;
    if (typeof data === 'string') {
      drugData = JSON.parse(data);
    }

    // Á°Æ‰øùÊï∞ÊçÆÂíå openfda ÂØπË±°Â≠òÂú®
    if (!drugData || !drugData.openfda) {
      console.error('Êó†ÊïàÁöÑËçØÂìÅÊï∞ÊçÆ');
      return;
    }

    const openfda = drugData.openfda;
    console.log('openfda Êï∞ÊçÆ:', openfda);

    // Êõ¥Êñ∞ËçØÂìÅ‰ø°ÊÅØ
    selectedMedicine.value = {
      name: openfda.brand_name?.[0] || openfda.generic_name?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      brandName: openfda.brand_name?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      genericName: openfda.generic_name?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      manufacturer: openfda.manufacturer_name?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      route: openfda.route?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      productType: openfda.product_type?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      purpose: drugData.purpose?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      indications: drugData.indications_and_usage?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      dosage: drugData.dosage_and_administration?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      warnings: drugData.warnings?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      doNotUse: drugData.do_not_use?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      whenUsing: drugData.when_using?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      stopUse: drugData.stop_use?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      storage: drugData.storage_and_handling?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      activeIngredient: drugData.active_ingredient?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ',
      inactiveIngredient: drugData.inactive_ingredient?.[0] || 'ÊöÇÊó†‰ø°ÊÅØ'
    };

    console.log('ËÆæÁΩÆÂêéÁöÑËçØÂìÅ‰ø°ÊÅØ:', selectedMedicine.value);
  } catch (error) {
    console.error('ËÆæÁΩÆËçØÂìÅ‰ø°ÊÅØÊó∂Âá∫Èîô:', error);
    ElMessage.error('Â§ÑÁêÜËçØÂìÅ‰ø°ÊÅØÂ§±Ë¥•');
  }
};


const editRecord = (record) => {
  isEditing.value = true

  // Ëß£ÊûêÂâÇÈáèÔºåÂ¢ûÂä†Êõ¥‰∏•Ê†ºÁöÑÂåπÈÖç
  const dosageMatch = record.dosage?.match(/^([\d.]+)\s*(.+)$/)

  // Ëß£ÊûêÈ¢ëÁéáÔºåÂ¢ûÂä†ÂÆπÈîôÂ§ÑÁêÜ
  const frequencyMatch = record.frequency?.match(/ÊØèÂ§©(\d+)Ê¨°[,Ôºå]?\s*(.+)/)

  medicineForm.value = {
    ...initMedicineForm(), // ÂÖàÂàùÂßãÂåñÈªòËÆ§ÂÄº
    id: record.id,
    name: record.name,
    dosageAmount: dosageMatch ? parseFloat(dosageMatch[1]) : 1,
    dosageUnit: dosageMatch ? dosageMatch[2].trim() : '',
    frequencyTimes: frequencyMatch ? frequencyMatch[1] : '1',
    frequencyPeriod: frequencyMatch ? frequencyMatch[2].trim() : '',
    frequencyTiming: Array.isArray(record.frequencyTiming) ?
        record.frequencyTiming :
        new Array(parseInt(frequencyMatch?.[1] || 1)).fill(''),
    startDate: record.startDate || '',
    endDate: record.endDate || '',
    notes: record.notes || '',
    drugInfo: record.drugInfo || null
  }

  // Á°Æ‰øùË°®ÂçïÊòæÁ§∫
  nextTick(() => {
    showAddForm.value = true
  })
}

const cancelForm = () => {
  showAddForm.value = false
  isEditing.value = false
  medicineForm.value = initMedicineForm()
}

const submitForm = async () => {
  if (!medicineFormRef.value) {
    console.warn('Ë°®ÂçïÂºïÁî®‰∏çÂ≠òÂú®');
    ElMessage.error('Ë°®ÂçïÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
    return;
  }

  if (!userId.value) {
    ElMessage.error('Áî®Êà∑Êú™ÁôªÂΩï');
    router.push('/login');
    return;
  }

  try {
    // Ë°®ÂçïÈ™åËØÅ
    const valid = await medicineFormRef.value.validate().catch(error => {
      console.error('Ë°®ÂçïÈ™åËØÅÂá∫Èîô:', error);
      return false;
    });

    if (!valid) {
      ElMessage.warning('ËØ∑Â°´ÂÜôÂøÖË¶Å‰ø°ÊÅØ');
      return;
    }

    // È™åËØÅÂâÇÈáèÂíåÈ¢ëÁéá
    if (!medicineForm.value.dosageAmount || !medicineForm.value.dosageUnit) {
      ElMessage.warning('ËØ∑ÂÆåÊï¥Â°´ÂÜôÁî®ËçØÂâÇÈáè');
      return;
    }

    if (!medicineForm.value.frequencyTimes || !medicineForm.value.frequencyPeriod) {
      ElMessage.warning('ËØ∑ÂÆåÊï¥Â°´ÂÜôÊúçÁî®È¢ëÁéá');
      return;
    }

    // È™åËØÅÊúçÁî®Êó∂Èó¥
    const timings = (medicineForm.value.frequencyTiming || []).filter(time => time && time.trim());
    const expectedTimings = parseInt(medicineForm.value.frequencyTimes || '0');

    if (timings.length !== expectedTimings) {
      ElMessage.warning(`ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊúçÁî®Êó∂Èó¥ÔºàÈúÄË¶Å ${expectedTimings} ‰∏™Êó∂Èó¥Ôºâ`);
      return;
    }

    // ÊûÑÂª∫Êèê‰∫§Êï∞ÊçÆ
    const formData = {
      id: medicineForm.value.id || null,
      userId: userId.value,
      name: (medicineForm.value.name || '').trim(),
      dosage: `${medicineForm.value.dosageAmount || 0}${medicineForm.value.dosageUnit || ''}`,
      frequency: `ÊØèÂ§©${medicineForm.value.frequencyTimes || 1}Ê¨°,${medicineForm.value.frequencyPeriod || ''}`,
      frequencyTiming: timings,
      startDate: medicineForm.value.startDate || null,
      endDate: medicineForm.value.endDate || null,
      notes: (medicineForm.value.notes || '').trim(),
      drugInfo: medicineForm.value.drugInfo ?
          (typeof medicineForm.value.drugInfo === 'string' ?
                  medicineForm.value.drugInfo :
                  JSON.stringify(medicineForm.value.drugInfo)
          ) : null
    };

    console.log('ÂáÜÂ§áÊèê‰∫§ÁöÑÊï∞ÊçÆ:', formData);

    loading.value = true;
    let response;

    if (isEditing.value) {
      // ‰øÆÊîπÔºö‰º†ÈÄímedicineIdÂèÇÊï∞
      response = await MedicineService.updateMedicineRecord(userId.value, formData.id, formData);
    } else {
      response = await MedicineService.createMedicineRecord(userId.value, formData);
    }

    // Ê£ÄÊü•ÂìçÂ∫î - ‰øÆÊîπÔºöÁõ¥Êé•Ê£ÄÊü•code
    if (response && response.code === 200) {
      ElMessage.success(isEditing.value ? 'Êõ¥Êñ∞ÊàêÂäü' : 'Ê∑ªÂä†ÊàêÂäü');
      showAddForm.value = false;
      isEditing.value = false;
      medicineForm.value = initMedicineForm();
      await fetchMedicineRecords();
    } else {
      throw new Error(response?.message || 'Êìç‰ΩúÂ§±Ë¥•');
    }
  } catch (error) {
    console.error('Ë°®ÂçïÊèê‰∫§ÈîôËØØ:', error);

    let errorMessage = 'Êìç‰ΩúÂ§±Ë¥•';
    if (error.message) {
      errorMessage = error.message;
    }

    ElMessage.error(errorMessage);
  } finally {
    loading.value = false;
  }
};

const setReminder = (medicineId) => {
  reminderForm.value.medicineId = medicineId
  showReminderForm.value = true
}

const submitReminder = async () => {
  try {
    if (!reminderForm.value.reminderTime) {
      ElMessage.warning('ËØ∑ÈÄâÊã©ÊèêÈÜíÊó∂Èó¥');
      return;
    }

    const reminderData = {
      medicineId: reminderForm.value.medicineId,
      reminderTime: reminderForm.value.reminderTime,
      repeatType: reminderForm.value.repeatType.toUpperCase(),
      isActive: true
    };

    console.log('Êèê‰∫§ÊèêÈÜíÊï∞ÊçÆ:', reminderData);

    const response = await MedicineService.createMedicineReminder(userId.value, reminderData);

    if (response && response.code === 200) {
      ElMessage.success('ËÆæÁΩÆÊèêÈÜíÊàêÂäü');
      await fetchReminders();
      showReminderForm.value = false;
      reminderForm.value = {
        medicineId: null,
        reminderTime: null,
        repeatType: 'daily',
        isActive: true
      };
    } else {
      throw new Error(response?.message || 'ËÆæÁΩÆÊèêÈÜíÂ§±Ë¥•');
    }
  } catch (error) {
    console.error('ËÆæÁΩÆÊèêÈÜíÂ§±Ë¥•:', error);
    ElMessage.error(error.message || 'ËÆæÁΩÆÊèêÈÜíÂ§±Ë¥•');
  }
};


const toggleReminder = async (reminder) => {
  try {
    const response = await MedicineService.updateReminderStatus(
        userId.value,
        reminder.id,
        reminder.isActive
    )

    // ‰øÆÊîπÔºöÊ£ÄÊü•response.code
    if (response && response.code === 200) {
      ElMessage.success('Êõ¥Êñ∞ÊèêÈÜíÁä∂ÊÄÅÊàêÂäü')
    } else {
      throw new Error(response?.message || 'Êõ¥Êñ∞ÊèêÈÜíÁä∂ÊÄÅÂ§±Ë¥•');
    }
  } catch (error) {
    reminder.isActive = !reminder.isActive // ÂõûÊªöÁä∂ÊÄÅ
    console.error('Êõ¥Êñ∞ÊèêÈÜíÁä∂ÊÄÅÂ§±Ë¥•:', error)
    ElMessage.error(error.message || 'Êõ¥Êñ∞ÊèêÈÜíÁä∂ÊÄÅÂ§±Ë¥•')
  }
}

const searchMedicine = async () => {
  if (!searchQuery.value.trim()) {
    ElMessage.warning('ËØ∑ËæìÂÖ•Ë¶ÅÊêúÁ¥¢ÁöÑËçØÂìÅÂêçÁß∞');
    return;
  }

  try {
    loading.value = true;
    console.log('ÊêúÁ¥¢ËçØÂìÅ:', searchQuery.value);

    // ÂÖàÂ∞ùËØïÁ≤æÁ°ÆÊêúÁ¥¢
    let response = await MedicineService.searchDrugLabels(searchQuery.value);

    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÁªìÊûúÔºåÂ∞ùËØï‰ΩøÁî®Êõ¥ÁÆÄÂçïÁöÑÊêúÁ¥¢Êù°‰ª∂
    if (!response.results?.length) {
      const simpleQuery = searchQuery.value.split(' ')[0];
      console.log('‰ΩøÁî®ÁÆÄÂåñÊêúÁ¥¢ËØç:', simpleQuery);
      response = await MedicineService.searchDrugLabels(simpleQuery);
    }

    if (response.results?.length > 0) {
      const result = response.results[0];
      setSelectedMedicine(result);
      showDetailsDialog.value = true;
    } else {
      ElMessage({
        message: 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËçØÂìÅ‰ø°ÊÅØÔºåËØ∑Ê£ÄÊü•ËçØÂìÅÂêçÁß∞ÊòØÂê¶Ê≠£Á°Æ',
        type: 'warning',
        duration: 3000
      });
    }
  } catch (error) {
    console.error('ÊêúÁ¥¢ËçØÂìÅÂ§±Ë¥•:', error);
    ElMessage.error('ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
  } finally {
    loading.value = false;
  }
};

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(async () => {
  if (!userId.value) {
    router.push('/login')
    return
  }
  await refreshRecords()
})

// ÁõëÂê¨ÂâÇÈáèÂçï‰ΩçÂèòÂåñ
watch(() => medicineForm.value.dosageUnit, (newVal) => {
  if (newVal && medicineForm.value.dosageAmount) {
    // Ëá™Âä®ËΩ¨Êç¢‰∏Ä‰∫õÂ∏∏ËßÅÁöÑÂçï‰ΩçÊç¢ÁÆó
    if (newVal === 'g' && medicineForm.value.dosageAmount >= 1000) {
      medicineForm.value.dosageAmount /= 1000
    }
  }
})

// ÁõëÂê¨ÊúçÁî®È¢ëÁéáÂèòÂåñ
watch(() => medicineForm.value.frequencyTimes, (newVal) => {
  if (newVal) {
    // ÈáçÁΩÆÊúçÁî®Êó∂Èó¥Êï∞ÁªÑ
    medicineForm.value.frequencyTiming = Array(Number(newVal))
        .fill('')
        .map((_, index) => medicineForm.value.frequencyTiming[index] || '')
  }
}, { immediate: true })
</script>

<style scoped>
/* ÂÖ®Â±ÄÊ†∑Âºè */
.medicine-management {
  height: 100vh;
  background: #f9fafb;
  padding: 0;
  overflow-x: hidden;
  overflow-y: auto;
}

/* Â§¥ÈÉ®Ê®™ÂπÖ */
.header-banner {
  background: linear-gradient(135deg, #b4b5f8 0%, #c3aef4 100%);
  color: white;
  padding: 10px 10px 45px;
  position: relative;
  overflow: hidden;
}

.banner-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  z-index: 1;
}

.banner-text .page-title {
  font-size: 2.5rem;
  margin: 0 0 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 16px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-subtitle {
  font-size: 1.1rem;
  margin: 0;
  opacity: 0.9;
  font-weight: 300;
}

.add-button {
  padding: 16px 32px;
  font-size: 16px;
  border-radius: 25px;
  background: rgba(255,255,255,0.15);
  border: 2px solid rgba(255,255,255,0.3);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.add-button:hover {
  background: rgba(255,255,255,0.25);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

/* ÊêúÁ¥¢Âå∫Âüü */
.search-section {
  max-width: 1200px;
  margin: -50px auto 40px;
  padding: 0 20px;
  position: relative;
  z-index: 2;
  display: flex;
  gap: 20px;
  align-items: center;
}

.search-container {
  flex: 1;
}

.search-input {
  border-radius: 25px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  background: white;
}

.search-input :deep(.el-input__wrapper) {
  border-radius: 25px;
  padding: 0 20px;
  box-shadow: none;
  border: none;
}

.search-btn {
  border-radius: 0 25px 25px 0;
  padding: 0 25px;
  border: none;
}

.filter-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.period-filter {
  width: 150px;
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.period-filter :deep(.el-input__wrapper) {
  border-radius: 20px;
  border: none;
  box-shadow: none;
}

.refresh-btn {
  background: white;
  border: none;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.refresh-btn:hover {
  transform: rotate(180deg);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* ÊêúÁ¥¢Âª∫ËÆÆÊ†∑Âºè */
.search-autocomplete-wrapper {
  position: relative;
}

.search-suggestion-item {
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.search-suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-name {
  font-weight: 500;
  color: #303133;
  margin-bottom: 2px;
}

.suggestion-info {
  font-size: 12px;
  color: #909399;
  line-height: 1.2;
}

/* Ëá™Âä®Ë°•ÂÖ®‰∏ãÊãâÊ°ÜÊ†∑Âºè */
:deep(.el-autocomplete-suggestion) {
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  border: none;
  margin-top: 8px;
}

:deep(.el-autocomplete-suggestion__wrap) {
  padding: 8px 0;
}

:deep(.el-autocomplete-suggestion li) {
  padding: 10px 16px;
  border-radius: 8px;
  margin: 2px 8px;
  transition: all 0.2s ease;
}

:deep(.el-autocomplete-suggestion li:hover) {
  background: #f0f9ff;
  transform: translateX(2px);
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px 40px;
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 30px;
  align-items: stretch;
  min-height: 0;
}

/* Âç°ÁâáÈÄöÁî®Ê†∑Âºè */
.medicine-records-card,
.medicine-reminders-card {
  border-radius: 20px;
  border: none;
  overflow: hidden;
  background: white;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  max-height: 70vh;
}

.medicine-records-card:hover,
.medicine-reminders-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}

.card-header {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  padding: 20px 25px;
  border-bottom: 1px solid #e2e8f0;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 18px;
  font-weight: 600;
  color: #334155;
}

.header-icon {
  font-size: 24px;
  color: #4f46e5;
  background: rgba(79, 70, 229, 0.1);
  padding: 4px;
  border-radius: 10px;
}

.record-count,
.reminder-count {
  margin-left: auto;
}

.card-body {
  padding: 25px;
  flex: 1;
  overflow: auto;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* ËÆ∞ÂΩïÁΩëÊ†º */
.records-grid {
  display: grid;
  gap: 20px;
}

.record-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  border: 1px solid #e2e8f0;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.record-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  border-radius: 0 2px 2px 0;
}

.record-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  border-color: #4f46e5;
}

.record-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.medicine-info {
  flex: 1;
}

.medicine-name {
  font-size: 18px;
  font-weight: 600;
  color: #1e293b;
  margin: 0 0 8px;
}

.status-tag {
  border-radius: 12px;
  font-size: 12px;
  padding: 4px 12px;
}

.record-menu .menu-btn {
  color: #64748b;
  padding: 8px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.record-menu .menu-btn:hover {
  background: #f1f5f9;
  color: #4f46e5;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.info-icon {
  font-size: 16px;
  color: #4f46e5;
  background: rgba(79, 70, 229, 0.1);
  padding: 6px;
  border-radius: 6px;
}

.info-text {
  display: flex;
  flex-direction: column;
}

.info-label {
  font-size: 12px;
  color: #64748b;
  font-weight: 500;
}

.info-value {
  font-size: 14px;
  color: #1e293b;
  font-weight: 600;
}

.date-range {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding: 8px 12px;
  background: #fef3c7;
  border-radius: 8px;
  border: 1px solid #f59e0b;
}

.date-icon {
  color: #d97706;
  font-size: 14px;
}

.date-text {
  font-size: 13px;
  color: #92400e;
}

.date-separator {
  margin: 0 6px;
  font-weight: 500;
}

.notes-section {
  background: #f0f9ff;
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  padding: 12px;
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.notes-icon {
  color: #0369a1;
  font-size: 14px;
  margin-top: 2px;
}

.notes-text {
  font-size: 13px;
  color: #0c4a6e;
  margin: 0;
  line-height: 1.4;
}

/* ÊèêÈÜíÂç°ÁâáÊ†∑Âºè */
.reminders-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.reminder-card {
  display: flex;
  align-items: center;
  padding: 16px;
  background: #ffffff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  transition: all 0.3s ease;
  position: relative;
}

.reminder-card:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.reminder-card.reminder-active {
  border-color: #10b981;
  background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
}

.reminder-status {
  margin-right: 12px;
}

.status-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #d1d5db;
  transition: all 0.3s ease;
}

.status-indicator.active {
  background: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}

.reminder-content {
  flex: 1;
}

.reminder-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.reminder-info {
  flex: 1;
}

.reminder-title {
  font-size: 13px;
  font-weight: 600;
  color: #373737;
  margin: 0 0 4px 0;
  line-height: 1.2;
}

.reminder-medicine {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
  margin: 0;
}

.reminder-status-tag {
  border-radius: 8px;
  font-size: 11px;
}

.reminder-details {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.detail-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.detail-icon {
  font-size: 12px;
  color: #64748b;
}

.detail-text {
  font-size: 12px;
  color: #64748b;
}

.reminder-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}

.reminder-switch {
  transform: scale(0.8);
}

.delete-btn {
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 6px;
}

/* Á©∫Áä∂ÊÄÅÊ†∑Âºè */
.custom-empty {
  padding: 40px 20px;
}

.empty-image {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.6;
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
.records-scrollbar,
.reminders-scrollbar {
  flex: 1;
  min-height: 0;
}

.records-scrollbar :deep(.el-scrollbar__thumb) {
  background: rgba(79, 70, 229, 0.3);
  border-radius: 10px;
}

.reminders-scrollbar :deep(.el-scrollbar__thumb) {
  background: rgba(16, 185, 129, 0.3);
  border-radius: 10px;
}

/* ÂØπËØùÊ°ÜÂíåË°®ÂçïÊ†∑Âºè */
.dosage-form-item :deep(.el-input-number) {
  margin-right: 10px;
}

.el-time-select {
  margin-bottom: 10px;
}

:deep(.el-select) {
  margin-right: 10px;
}

/* È¢ëÁéáÈÄâÊã©Ê°ÜÊ†∑Âºè */
.frequency-select {
  width: 120px !important;
}

/* Êó∂ÊÆµÈÄâÊã©Ê°ÜÊ†∑Âºè */
.period-select {
  width: 120px !important;
}

/* Á°Æ‰øùÈÄâÊã©Ê°ÜÂÜÖÂÆπÂ±Ö‰∏≠ÂØπÈΩê */
:deep(.el-select .el-input__inner) {
  text-align: left;
  padding-left: 12px;
}

/* Âçï‰ΩçÈÄâÊã©Ê°ÜÊ†∑Âºè */
.unit-select {
  width: 120px !important;
}

:deep(.el-dialog__body) {
  padding-top: 20px;
}

.drug-details {
  padding: 20px;
}

.mb-4 {
  margin-bottom: 16px;
}

.p-3 {
  padding: 12px;
}

:deep(.el-descriptions__cell) {
  padding: 12px 20px;
}

:deep(.el-collapse-item__content) {
  padding: 0;
}

:deep(.el-collapse-item__header) {
  font-size: 14px;
  font-weight: 500;
}

:deep(.el-form-item__content) {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  width: 100%;
}

.dosage-input {
  width: 120px !important;
}

:deep(.el-form-item__error) {
  position: relative;
  top: 100%;
  left: 0;
}

.nested-form-item {
  display: flex;
  gap: 10px;
  width: 100%;
}

.time-select-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.time-select-item {
  width: calc(50% - 5px);
  min-width: 120px;
}

/* ÊêúÁ¥¢Âª∫ËÆÆÊ†∑Âºè */
.search-autocomplete-wrapper {
  position: relative;
}

.search-suggestion-item {
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.search-suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-name {
  font-weight: 500;
  color: #303133;
  margin-bottom: 2px;
}

.suggestion-info {
  font-size: 12px;
  color: #909399;
  line-height: 1.2;
}

/* Ëá™Âä®Ë°•ÂÖ®‰∏ãÊãâÊ°ÜÊ†∑Âºè */
:deep(.el-autocomplete-suggestion) {
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  border: none;
  margin-top: 8px;
}

:deep(.el-autocomplete-suggestion__wrap) {
  padding: 8px 0;
}

:deep(.el-autocomplete-suggestion li) {
  padding: 10px 16px;
  border-radius: 8px;
  margin: 2px 8px;
  transition: all 0.2s ease;
}

:deep(.el-autocomplete-suggestion li:hover) {
  background: #f0f9ff;
  transform: translateX(2px);
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1024px) {
  .main-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .medicine-records-card,
  .medicine-reminders-card {
    max-height: 60vh;
  }
  
  .banner-content {
    flex-direction: column;
    text-align: center;
    gap: 20px;
  }
  
  .search-section {
    flex-direction: column;
    gap: 16px;
  }
}

@media (max-width: 768px) {
  .banner-text .page-title {
    font-size: 2rem;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .search-section {
    margin: -20px auto 30px;
  }
  
  .main-content {
    padding: 0 15px 30px;
  }
  
  .banner-content {
    padding: 0 15px;
  }
  
  .medicine-records-card,
  .medicine-reminders-card {
    max-height: 50vh;
  }
}

</style>